import type { Problem } from '@/types/problem';

export const problem: Problem = {
  id: 'database-008', level: 'database', order: 8,
  title: { ko: '연결 및 데이터베이스 정보 종합', en: 'Connection & Database Info Dashboard' },
  description: {
    ko: `데이터베이스의 **연결 현황과 종합 정보**를 한눈에 조회하세요.\n\n### 요구사항\n\`\`\`sql\nSELECT\n  current_database() AS database_name,\n  current_user AS connected_user,\n  pg_size_pretty(pg_database_size(current_database())) AS database_size,\n  (SELECT count(*) FROM pg_stat_activity WHERE datname = current_database()) AS active_connections,\n  (SELECT setting FROM pg_settings WHERE name = 'max_connections') AS max_connections,\n  (SELECT count(*) FROM pg_stat_user_tables) AS user_tables,\n  (SELECT count(*) FROM pg_stat_user_indexes) AS user_indexes,\n  pg_postmaster_start_time() AS server_start_time,\n  NOW() - pg_postmaster_start_time() AS uptime;\n\`\`\`\n\n### DBA 대시보드\n이 쿼리는 DBA가 서버 상태를 빠르게 파악하기 위한 **종합 대시보드 쿼리**입니다.\n- 현재 DB 이름, 사용자, 크기\n- 활성 연결 수 / 최대 연결 수\n- 테이블 수, 인덱스 수\n- 서버 가동 시간`,
    en: `Query **connection status and overall database info** at a glance.\n\n### Requirements\n\`\`\`sql\nSELECT\n  current_database() AS database_name,\n  current_user AS connected_user,\n  pg_size_pretty(pg_database_size(current_database())) AS database_size,\n  (SELECT count(*) FROM pg_stat_activity WHERE datname = current_database()) AS active_connections,\n  (SELECT setting FROM pg_settings WHERE name = 'max_connections') AS max_connections,\n  (SELECT count(*) FROM pg_stat_user_tables) AS user_tables,\n  (SELECT count(*) FROM pg_stat_user_indexes) AS user_indexes,\n  pg_postmaster_start_time() AS server_start_time,\n  NOW() - pg_postmaster_start_time() AS uptime;\n\`\`\`\n\n### DBA Dashboard\nThis is a **comprehensive dashboard query** for DBA to quickly assess server status:\n- Current DB name, user, size\n- Active connections / max connections\n- Table count, index count\n- Server uptime`,
  },
  schema: 'ecommerce', category: 'Monitoring', difficulty: 2,
  hints: {
    ko: ['서브쿼리를 SELECT 절에 넣어 여러 정보를 한 행으로 조회합니다.', 'pg_postmaster_start_time()으로 서버 시작 시간을 확인합니다.', "SELECT current_database() AS database_name, current_user AS connected_user, pg_size_pretty(pg_database_size(current_database())) AS database_size, (SELECT count(*) FROM pg_stat_activity WHERE datname = current_database()) AS active_connections, (SELECT setting FROM pg_settings WHERE name = 'max_connections') AS max_connections, (SELECT count(*) FROM pg_stat_user_tables) AS user_tables, (SELECT count(*) FROM pg_stat_user_indexes) AS user_indexes, pg_postmaster_start_time() AS server_start_time, NOW() - pg_postmaster_start_time() AS uptime;"],
    en: ['Use scalar subqueries in SELECT to get multiple metrics in one row.', 'pg_postmaster_start_time() shows server start time.', "SELECT current_database() AS database_name, current_user AS connected_user, pg_size_pretty(pg_database_size(current_database())) AS database_size, (SELECT count(*) FROM pg_stat_activity WHERE datname = current_database()) AS active_connections, (SELECT setting FROM pg_settings WHERE name = 'max_connections') AS max_connections, (SELECT count(*) FROM pg_stat_user_tables) AS user_tables, (SELECT count(*) FROM pg_stat_user_indexes) AS user_indexes, pg_postmaster_start_time() AS server_start_time, NOW() - pg_postmaster_start_time() AS uptime;"],
  },
  explanation: {
    ko: `## DBA 대시보드 쿼리\n\n### 주요 시스템 함수\n| 함수 | 설명 |\n|------|------|\n| current_database() | 현재 데이터베이스 이름 |\n| current_user | 현재 접속 사용자 |\n| pg_database_size() | DB 크기 (바이트) |\n| pg_postmaster_start_time() | 서버 시작 시간 |\n| NOW() | 현재 시간 |\n\n### 주요 시스템 뷰\n| 뷰 | 설명 |\n|----|------|\n| pg_stat_activity | 현재 세션/쿼리 |\n| pg_stat_user_tables | 테이블 통계 |\n| pg_stat_user_indexes | 인덱스 통계 |\n| pg_settings | 설정값 |\n| pg_locks | 잠금 상태 |\n\n### 실무 DBA 대시보드 구성\n- **연결 현황**: active/idle 비율, max_connections 대비 사용률\n- **디스크 사용량**: DB 크기, 테이블별 크기, 인덱스 크기\n- **성능 지표**: 캐시 히트율, 인덱스 사용률\n- **유지보수 상태**: 마지막 VACUUM/ANALYZE 시간\n- **잠금 현황**: 블로킹 세션 수\n\n### 캐시 히트율 확인\n\`\`\`sql\nSELECT\n  ROUND(\n    SUM(heap_blks_hit) * 100.0 /\n    NULLIF(SUM(heap_blks_hit) + SUM(heap_blks_read), 0), 2\n  ) AS cache_hit_ratio\nFROM pg_statio_user_tables;\n-- 목표: 99% 이상\n\`\`\``,
    en: `## DBA Dashboard Query\n\n### Key System Functions\n| Function | Description |\n|----------|-------------|\n| current_database() | Current database name |\n| current_user | Current connected user |\n| pg_database_size() | DB size (bytes) |\n| pg_postmaster_start_time() | Server start time |\n| NOW() | Current time |\n\n### Key System Views\n| View | Description |\n|------|-------------|\n| pg_stat_activity | Current sessions/queries |\n| pg_stat_user_tables | Table statistics |\n| pg_stat_user_indexes | Index statistics |\n| pg_settings | Configuration values |\n| pg_locks | Lock status |\n\n### Production DBA Dashboard\n- **Connections**: active/idle ratio, usage vs max_connections\n- **Disk usage**: DB size, per-table size, index sizes\n- **Performance**: Cache hit ratio, index usage rates\n- **Maintenance**: Last VACUUM/ANALYZE times\n- **Locks**: Blocking session count\n\n### Cache Hit Ratio\n\`\`\`sql\nSELECT\n  ROUND(\n    SUM(heap_blks_hit) * 100.0 /\n    NULLIF(SUM(heap_blks_hit) + SUM(heap_blks_read), 0), 2\n  ) AS cache_hit_ratio\nFROM pg_statio_user_tables;\n-- Target: 99%+\n\`\`\``,
  },
  expectedQuery: {
    postgresql: "SELECT current_database() AS database_name, current_user AS connected_user, pg_size_pretty(pg_database_size(current_database())) AS database_size, (SELECT count(*) FROM pg_stat_activity WHERE datname = current_database()) AS active_connections, (SELECT setting FROM pg_settings WHERE name = 'max_connections') AS max_connections, (SELECT count(*) FROM pg_stat_user_tables) AS user_tables, (SELECT count(*) FROM pg_stat_user_indexes) AS user_indexes, pg_postmaster_start_time() AS server_start_time, NOW() - pg_postmaster_start_time() AS uptime;",
    mysql: "SELECT current_database() AS database_name, current_user AS connected_user, pg_size_pretty(pg_database_size(current_database())) AS database_size, (SELECT count(*) FROM pg_stat_activity WHERE datname = current_database()) AS active_connections, (SELECT setting FROM pg_settings WHERE name = 'max_connections') AS max_connections, (SELECT count(*) FROM pg_stat_user_tables) AS user_tables, (SELECT count(*) FROM pg_stat_user_indexes) AS user_indexes, pg_postmaster_start_time() AS server_start_time, NOW() - pg_postmaster_start_time() AS uptime;",
  },
  gradingMode: 'exact', relatedConcepts: ['Dashboard', 'Monitoring', 'System Functions', 'DBA', 'Comprehensive'],
};
