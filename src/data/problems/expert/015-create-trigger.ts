import type { Problem } from '@/types/problem';

export const problem: Problem = {
  id: 'expert-015', level: 'expert', order: 15,
  title: { ko: 'CREATE TRIGGER: 감사 로그 트리거', en: 'CREATE TRIGGER: Audit Log Trigger' },
  description: {
    ko: `제품 가격 변경 시 자동으로 로그를 기록하는 트리거를 생성하세요.\n\n### 요구사항\n1. 감사 로그 테이블을 생성하세요:\n\`\`\`sql\nCREATE TABLE IF NOT EXISTS price_audit_log (\n  id SERIAL PRIMARY KEY,\n  product_id INTEGER NOT NULL,\n  old_price DECIMAL(10,2),\n  new_price DECIMAL(10,2),\n  changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\`\`\`\n\n2. 트리거 함수를 생성하세요:\n\`\`\`sql\nCREATE OR REPLACE FUNCTION log_price_change()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF OLD.price <> NEW.price THEN\n    INSERT INTO price_audit_log (product_id, old_price, new_price)\n    VALUES (OLD.id, OLD.price, NEW.price);\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\`\`\`\n\n3. 트리거를 생성하세요:\n\`\`\`sql\nCREATE TRIGGER trg_price_change\nBEFORE UPDATE ON products\nFOR EACH ROW\nEXECUTE FUNCTION log_price_change();\n\`\`\`\n\n4. 트리거 확인:\n\`\`\`sql\nSELECT trigger_name, event_manipulation, action_timing\nFROM information_schema.triggers\nWHERE trigger_schema = 'public'\n  AND event_object_table = 'products';\n\`\`\`\n\n> **채점**: 4번 SELECT 쿼리의 결과로 채점됩니다.`,
    en: `Create a trigger that automatically logs product price changes.\n\n### Requirements\n1. Create audit log table:\n\`\`\`sql\nCREATE TABLE IF NOT EXISTS price_audit_log (\n  id SERIAL PRIMARY KEY,\n  product_id INTEGER NOT NULL,\n  old_price DECIMAL(10,2),\n  new_price DECIMAL(10,2),\n  changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\`\`\`\n\n2. Create trigger function:\n\`\`\`sql\nCREATE OR REPLACE FUNCTION log_price_change()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF OLD.price <> NEW.price THEN\n    INSERT INTO price_audit_log (product_id, old_price, new_price)\n    VALUES (OLD.id, OLD.price, NEW.price);\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\`\`\`\n\n3. Create the trigger:\n\`\`\`sql\nCREATE TRIGGER trg_price_change\nBEFORE UPDATE ON products\nFOR EACH ROW\nEXECUTE FUNCTION log_price_change();\n\`\`\`\n\n4. Verify trigger:\n\`\`\`sql\nSELECT trigger_name, event_manipulation, action_timing\nFROM information_schema.triggers\nWHERE trigger_schema = 'public'\n  AND event_object_table = 'products';\n\`\`\`\n\n> **Grading**: Based on step 4's SELECT result.`,
  },
  schema: 'ecommerce', category: 'DDL', difficulty: 3,
  hints: {
    ko: ['PostgreSQL에서 트리거는 트리거 함수(FUNCTION)를 먼저 만들어야 합니다.', 'OLD.컬럼과 NEW.컬럼으로 변경 전/후 값에 접근합니다.', "SELECT trigger_name, event_manipulation, action_timing FROM information_schema.triggers WHERE trigger_schema = 'public' AND event_object_table = 'products';"],
    en: ['In PostgreSQL, you must create a trigger FUNCTION first.', 'Access old/new values via OLD.column and NEW.column.', "SELECT trigger_name, event_manipulation, action_timing FROM information_schema.triggers WHERE trigger_schema = 'public' AND event_object_table = 'products';"],
  },
  explanation: {
    ko: `## CREATE TRIGGER (트리거)\n\n트리거는 특정 이벤트(INSERT, UPDATE, DELETE) 발생 시 **자동으로 실행되는 함수**입니다.\n\n### PostgreSQL 트리거 생성 과정\n\`\`\`sql\n-- 1. 트리거 함수 생성\nCREATE OR REPLACE FUNCTION log_price_change()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF OLD.price <> NEW.price THEN\n    INSERT INTO price_audit_log (...) VALUES (...);\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- 2. 트리거 연결\nCREATE TRIGGER trg_price_change\nBEFORE UPDATE ON products\nFOR EACH ROW\nEXECUTE FUNCTION log_price_change();\n\`\`\`\n\n### 트리거 타이밍\n| 타이밍 | 설명 |\n|--------|------|\n| BEFORE | 실행 전 (값 수정 가능) |\n| AFTER | 실행 후 (로깅에 적합) |\n| INSTEAD OF | 대신 실행 (뷰에 사용) |\n\n### 트리거 이벤트\n- INSERT, UPDATE, DELETE, TRUNCATE\n\n### OLD / NEW\n| 이벤트 | OLD | NEW |\n|--------|-----|-----|\n| INSERT | 없음 | 새 행 |\n| UPDATE | 변경 전 | 변경 후 |\n| DELETE | 삭제된 행 | 없음 |\n\n### 실무 활용\n- **감사 로그**: 누가 언제 무엇을 변경했는지 기록\n- **데이터 검증**: 복잡한 비즈니스 규칙 적용\n- **자동 계산**: 변경 시 관련 데이터 자동 갱신\n- **알림**: 특정 조건 발생 시 알림 트리거`,
    en: `## CREATE TRIGGER\n\nTriggers are **functions that execute automatically** when specific events (INSERT, UPDATE, DELETE) occur.\n\n### PostgreSQL Trigger Creation\n\`\`\`sql\n-- 1. Create trigger function\nCREATE OR REPLACE FUNCTION log_price_change()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF OLD.price <> NEW.price THEN\n    INSERT INTO price_audit_log (...) VALUES (...);\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- 2. Attach trigger\nCREATE TRIGGER trg_price_change\nBEFORE UPDATE ON products\nFOR EACH ROW\nEXECUTE FUNCTION log_price_change();\n\`\`\`\n\n### Trigger Timing\n| Timing | Description |\n|--------|-------------|\n| BEFORE | Before execution (can modify values) |\n| AFTER | After execution (ideal for logging) |\n| INSTEAD OF | Execute instead (used with views) |\n\n### Trigger Events\n- INSERT, UPDATE, DELETE, TRUNCATE\n\n### OLD / NEW\n| Event | OLD | NEW |\n|-------|-----|-----|\n| INSERT | None | New row |\n| UPDATE | Before change | After change |\n| DELETE | Deleted row | None |\n\n### Real-World Uses\n- **Audit logs**: Track who changed what and when\n- **Data validation**: Enforce complex business rules\n- **Auto-computation**: Auto-update related data\n- **Notifications**: Trigger alerts on conditions`,
  },
  expectedQuery: {
    postgresql: "SELECT trigger_name, event_manipulation, action_timing FROM information_schema.triggers WHERE trigger_schema = 'public' AND event_object_table = 'products';",
    mysql: "SELECT trigger_name, event_manipulation, action_timing FROM information_schema.triggers WHERE trigger_schema = 'public' AND event_object_table = 'products';",
  },
  gradingMode: 'exact', relatedConcepts: ['CREATE TRIGGER', 'CREATE FUNCTION', 'PL/pgSQL', 'Audit Log', 'DDL', 'DBA'],
};
